<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCAR ADT Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        body { font-family: 'Roboto', sans-serif; }
        .container { max-width: 100%; margin: 0 auto; padding: 10px; box-sizing: border-box; position: relative; }
        h1 { text-align: left; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-family: 'Roboto', sans-serif; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f1f1; }
        input, select { width: 100%; box-sizing: border-box; }
        button { padding: 5px 10px; margin-top: 10px; }
        select {
            width: 100%; /* Consistent width with input elements */
        }
        select option {
            width: auto; /* Allow the dropdown menu to scale to the content */
        }
        .error { border: 2px solid red; }
        .generate-csv-btn { position: absolute; top: 10px; right: 10px; }
        .top-bar {
            background-color: #333;
            overflow: hidden;
        }
        .top-bar a {
            float: left;
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }
        .top-bar a:hover {
            background-color: #ddd;
            color: black;
        }
    </style>
</head>
<body>
    <div id="topbar-placeholder"></div>
    <div class="container">
        <h1>OSCAR ADT Generator</h1>
        <button type="button" class="generate-csv-btn">Generate and download .csv</button>
        
        <section>
            <p>
                This page allows you to generate an ADT file for use with the <a href="https://github.com/ollieeknight/OSCAR" target="_blank">Romagnani lab OSCAR pipeline</a>.<br>
                This pipeline takes raw sequencing data and performs cellranger counting, as well as quality control, doublet detection, and donor genotype deconvolution, as detailed <a href="https://github.com/ollieeknight/OSCAR" target="_blank">here</a>.
            </p>
        </section>        
        
        <section>
            <p>Several input variables are required to make the ADT file. These are detailed below:</p>
            <ul>
                <li>Catalogue number: The catalogue number of the antibody</li>
                <li>ID: A unique identifier for the antibody</li>
                <li>Marker: The marker that the antibody targets</li>
                <li>Clone: The clone of the antibody</li>
                <li>Reactivity: The reactivity of the antibody (e.g., Human, Mouse, etc.)</li>
                <li>Barcode: The barcode sequence of the antibody</li>
            </ul>
        </section>        
        
        <div id="messageContainer" style="color: red; display: none;"></div>
        <form id="csvForm">
            <table>
                <thead>
                    <tr>
                        <th>Catalogue number</th>
                        <th>ID</th>
                        <th>Marker</th>
                        <th>Clone</th>
                        <th>Reactivity</th>
                        <th>Barcode</th>
                    </tr>
                </thead>
                <tbody id="rowsContainer">
                    <!-- Rows will be dynamically added here -->
                </tbody>
            </table>
            <button type="button" class="add-row-btn">Add row</button>
        </form>
    </div>

    <script>
        async function fetchRowTemplate() {
            const response = await fetch('../row_template.html');
            const template = await response.text();
            return template;
        }

        async function addRow() {
            const container = document.getElementById('rowsContainer');
            const template = await fetchRowTemplate();
            const newRow = document.createElement('tr');
            newRow.innerHTML = template;
            container.appendChild(newRow);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            document.querySelector('.add-row-btn').addEventListener('click', addRow);
            document.querySelector('.generate-csv-btn').addEventListener('click', generateCSV);
            const container = document.getElementById('rowsContainer');
            const template = await fetchRowTemplate();
            const firstRow = document.createElement('tr');
            firstRow.innerHTML = template;
            container.appendChild(firstRow);
        });

        function generateCSV() {
            const rows = document.querySelectorAll('#rowsContainer tr');
            let csvContent = 'catalogue_number,id,marker,clone,reactivity,barcode\n';
            let allValid = true;

            rows.forEach(row => {
                const { rowValid, values } = validateRow(row);
                if (!rowValid) {
                    allValid = false;
                } else {
                    csvContent += values.join(',') + '\n';
                }
            });

            if (allValid) {
                downloadCSV(csvContent);
            } else {
                alert('Please complete all fields before generating the CSV.');
            }
        }

        function validateRow(row) {
            const inputs = row.querySelectorAll('input, select');
            const values = Array.from(inputs).map(input => input.value || 'NA');
            let rowValid = true;

            inputs.forEach(input => {
                if (input.value === '') {
                    input.classList.add('error');
                    rowValid = false;
                } else {
                    input.classList.remove('error');
                }
            });

            return { rowValid, values };
        }

        function downloadCSV(csvContent) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'adt.csv'; // Output file name
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // JavaScript to include the top bar
        fetch('topbar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('topbar-placeholder').innerHTML = data;

                // Determine the base path
                const basePath = window.location.pathname.includes('/pages/') ? '../' : '';

                // Set the href attributes
                document.getElementById('home-link').href = basePath + 'index.html';
                document.getElementById('metadata-link').href = basePath + 'pages/metadata_generator.html';
                document.getElementById('adt-link').href = basePath + 'pages/adt_generator.html';
                document.getElementById('references-link').href = basePath + 'pages/references.html';
            })
            .catch(error => {
                console.error('Error fetching topbar:', error);
            });
    </script>
</body>
</html>