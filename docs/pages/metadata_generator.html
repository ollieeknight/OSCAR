<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metadata file generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div id="topbar-placeholder"></div> <!-- Placeholder for the top bar -->
    <div class="container">
        <h1>Metadata file generator</h1>    

        <section>
            <p>
                This page allows you to generate a metadata file for use with the <a href="https://github.com/ollieeknight/OSCAR" target="_blank">Romagnani lab OSCAR pipeline</a>.<br>
                This pipeline takes raw sequencing data and performs cellranger counting, as well as quality control, doublet detection, and donor genotype deconvolution, as detailed <a href="https://github.com/ollieeknight/OSCAR" target="_blank">here</a>.
            </p>
        </section>        
        
        <section>
            <p>Several input variables are required to make the metadata file. These are detailed below:</p>
            <ul>
                <li>Assay type: The type of assay used (e.g., CITE, DOGMA, etc.)</li>
                <li>Experiment ID: A unique identifier for the experiment</li>
                <li>Historical number: A unique identifier, likely for the pool of cells loaded onto the 10x chip. For example, if you have two pools and load the first onto two GEMs and the second onto one, the first experiment would have a historical number of 1 and replicate names of A and B, and the second pool would have a historical number of 2 and a replicate name of A.</li>
                <li>Replicate: The replicate number for the experiment: see above.</li>
                <li>Modality: The modality of the experiment (e.g., Gene expression, ATAC, ADT, etc.)</li>
                <li>Chemistry: The chemistry used for the experiment (e.g., 3' v2, 3' v3, etc.). For more information see <a href="https://kb.10xgenomics.com/hc/en-us/articles/115003764132-How-does-Cell-Ranger-auto-detect-chemistry" target="_blank">here</a>.</li>
                <li>Index type: The type of index used (Single index or dual index). Refer to the assay used, and the plate or primers used to index your library.</li>
                <li>Index: The index used for the experiment. This is the barcode used to identify the sample.</li>
                <li>Species: The species of the sample (Human or mouse)</li>
                <li>Number of donors: The number of donors in this GEM well, used for donor deconvolution. Human only.</li>
                <li>ADT file name: The name of the ADT file used for the experiment. Exclude .csv suffix. This is the name of the file that contains ADT barcodes. The format must match the format for your experiment, detailed <a href="https://github.com/ollieeknight/OSCAR/tree/main/templates" target="_blank">here</a>.</li>
            </ul>
        </section>        
        
        <div id="messageContainer" style="color: red; display: none;"></div> <!-- Container for error messages -->
        <form id="csvForm">
            <table>
                <thead>
                    <tr>
                        <th>Assay type</th>
                        <th>Experiment ID</th>
                        <th>Historical number</th>
                        <th>Replicate</th>
                        <th>Modality</th>
                        <th>Chemistry</th>
                        <th>Index type</th>
                        <th>Index</th>
                        <th>Species</th>
                        <th>Number of donors</th>
                        <th>ADT .csv name</th>
                    </tr>
                </thead>
                <tbody id="rowsContainer">
                    <!-- Rows will be dynamically added here -->
                </tbody>
            </table>
            <button type="button" class="add-row-button">Add row</button> <!-- Button to add new rows -->
        </form>
    </div>

    <script>

        // Function to fetch the row template from an external HTML file
        async function fetchRowTemplate() {
            const response = await fetch('../pages/row_template.html');
            const template = await response.text();
            return template;
        }

        // Function to add a new row to the table
        async function addRow() {
            const container = document.getElementById('rowsContainer');
            const template = await fetchRowTemplate();
            const newRow = document.createElement('tr');
            newRow.innerHTML = template;
            container.appendChild(newRow);
        }

        // Event listener for DOMContentLoaded to set up initial rows and event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            document.querySelector('.add-row-button').addEventListener('click', addRow); // Add row button event listener
            document.querySelector('.generate-csv-button').addEventListener('click', generateCSV); // Generate CSV button event listener
            const container = document.getElementById('rowsContainer');
            const template = await fetchRowTemplate();
            const firstRow = document.createElement('tr');
            firstRow.innerHTML = template;
            container.appendChild(firstRow); // Add the first row on page load
        });

        // Function to generate the CSV content from the table rows
        function generateCSV() {
            const rows = document.querySelectorAll('#rowsContainer tr');
            let csvContent = 'assay,experiment_id,historical_number,replicate,modality,chemistry,index_type,index,species,n_donors,adt_file\n';
            let allValid = true;

            rows.forEach(row => {
                const { rowValid, values } = validateRow(row);
                if (!rowValid) {
                    allValid = false;
                } else {
                    csvContent += values.join(',') + '\n';
                }
            });

            if (allValid) {
                downloadCSV(csvContent); // Download the CSV if all rows are valid
            } else {
                alert('Please complete all fields before generating the CSV.'); // Alert if any row is invalid
            }
        }

        // Function to validate a row and collect its values
        function validateRow(row) {
            const inputs = row.querySelectorAll('input, select');
            const values = Array.from(inputs).map(input => input.value || 'NA');
            let rowValid = true;

            inputs.forEach(input => {
                if (input.value === '') {
                    input.classList.add('error'); // Add error class if input is empty
                    rowValid = false;
                } else {
                    input.classList.remove('error'); // Remove error class if input is not empty
                }
            });

            return { rowValid, values }; // Return validation status and values
        }

        // Function to download the generated CSV content
        function downloadCSV(csvContent) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'metadata.csv'; // Output file name
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // JavaScript to include the top bar
        fetch('./topbar.html')  // Fetch the top bar HTML
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                console.log('Topbar content loaded'); // Debug logging
                document.getElementById('topbar-placeholder').innerHTML = data;

                // Determine the base path
                const basePath = window.location.pathname.includes('/pages/') ? '../' : '';

                // Set the href attributes
                document.getElementById('home-link').href = basePath + 'index.html';
                document.getElementById('metadata-link').href = basePath + 'pages/metadata_generator.html';
                document.getElementById('adt-link').href = basePath + 'pages/adt_generator.html';
                document.getElementById('references-link').href = basePath + 'pages/references.html';
            })
            .catch(error => {
                console.error('Error loading topbar:', error);
                document.getElementById('topbar-placeholder').innerHTML = '<p>Error loading navigation</p>';
            });

    </script>
    <div class="right-align-container">
        <button class="generate-csv-button">Download metadata.csv</button> <!-- Button to generate and download the CSV -->
    </div>
</body>
</html>