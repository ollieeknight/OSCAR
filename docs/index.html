<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCAR Metadata Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; }
        .container { max-width: 100%; margin: 0 auto; padding: 10px; box-sizing: border-box; position: relative; }
        h1 { text-align: left; } /* Changed to left align */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-family: 'Roboto', sans-serif; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f1f1; }
        input, select { width: 100%; box-sizing: border-box; }
        button { padding: 5px 10px; margin-top: 10px; }
        select {
            width: 100px; /* Fixed width for the select box */
        }
        select option {
            width: auto; /* Allow the dropdown menu to scale to the content */
        }
        .error { border: 2px solid red; }
        .add-row-btn { position: absolute; top: 10px; left: 10px; }
        .generate-csv-btn { position: absolute; top: 10px; right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>OSCAR Metadata Generator</h1>
        <button type="button" class="generate-csv-btn" onclick="generateCSV()">Generate and download .csv</button>
        <form id="csvForm">
            <table>
                <thead>
                    <tr>
                        <th>Assay type</th>
                        <th>Experiment ID</th>
                        <th>Historical number</th>
                        <th>Replicate</th>
                        <th>Modality</th>
                        <th>Chemistry</th>
                        <th>Index type</th>
                        <th>Index</th>
                        <th>Species</th>
                        <th>Number of donors</th>
                        <th>ADT file name</th>
                    </tr>
                </thead>
                <tbody id="rowsContainer">
                    <!-- Rows will be dynamically added here -->
                </tbody>
            </table>
            <button type="button" class="add-row-btn" onclick="addRow()">Add row</button>
        </form>
    </div>

    <script>
        async function fetchRowTemplate() {
            const response = await fetch('row_template.html');
            const template = await response.text();
            return template;
        }

        async function addRow() {
            const container = document.getElementById('rowsContainer');
            const template = await fetchRowTemplate();
            const newRow = document.createElement('tr');
            newRow.innerHTML = template;
            container.appendChild(newRow);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('rowsContainer');
            const template = await fetchRowTemplate();
            const firstRow = document.createElement('tr');
            firstRow.innerHTML = template;
            container.appendChild(firstRow);
        });

        function generateCSV() {
            const rows = document.querySelectorAll('#rowsContainer tr');
            let csvContent = 'assay,experiment_id,historical_number,replicate,modality,chemistry,index_type,index,species,n_donors,adt_file\n';
            let allValid = true;

            rows.forEach(row => {
                const inputs = row.querySelectorAll('input, select');
                const values = Array.from(inputs).map(input => input.value || 'NA');
                let rowValid = true;

                inputs.forEach(input => {
                    if (input.value === '') {
                        input.classList.add('error');
                        rowValid = false;
                    } else {
                        input.classList.remove('error');
                    }
                });

                if (!rowValid) {
                    allValid = false;
                } else {
                    csvContent += values.join(',') + '\n';
                }
            });

            if (allValid) {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'metadata.csv'; // Output file name
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert('Please fill in all fields. Empty entries are not allowed.');
            }
        }
    </script>
</body>
</html>
