<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCAR Metadata Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; }
        .container { max-width: 100%; margin: 0 auto; padding: 10px; box-sizing: border-box; position: relative; }
        h1 { text-align: left; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-family: 'Roboto', sans-serif; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f1f1; }
        input, select { width: 100%; box-sizing: border-box; }
        button { padding: 5px 10px; margin-top: 10px; }
        select {
            width: 100%; /* Consistent width with input elements */
        }
        select option {
            width: auto; /* Allow the dropdown menu to scale to the content */
        }
        .error { border: 2px solid red; }
        .generate-csv-btn { position: absolute; top: 10px; right: 10px; }
        .top-bar {
            background-color: #333;
            overflow: hidden;
        }
        .top-bar a {
            float: left;
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }
        .top-bar a:hover {
            background-color: #ddd;
            color: black;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="index.html">Metadata generator</a>
        <a href="adt_list_generator.html">ADT list generator</a>
        <a href="references.html">References</a>
    </div>
    <div class="container">
        <h1>OSCAR Metadata Generator</h1>
        <button type="button" class="generate-csv-btn">Generate and download .csv</button>
        
        <section>
            <p>
                This page allows you to generate a metadata file for use with the <a href="https://github.com/ollieeknight/OSCAR" target="_blank">Romagnani lab OSCAR pipeline</a>.<br>
                This pipeline takes raw sequencing data and performs cellranger counting, as well as quality control, doublet detection, and donor genotype deconvolution, as detailed <a href="https://github.com/ollieeknight/OSCAR" target="_blank">here</a>.
            </p>
        </section>        
        
        <section>
            <p>Several input variables are required to make the metadata file. These are detailed below:</p>
            <ul>
                <li>Assay type: The type of assay used (e.g., CITE, DOGMA, etc.)</li>
                <li>Experiment ID: A unique identifier for the experiment</li>
                <li>Historical number: A unique identifier, likely for the pool of cells loaded onto the 10x chip. For example, if you have two pools and load the first onto two GEMs and the second onto one, the first experiment would have a historical number of 1 and replicate names of A and B, and the second pool would have a historical number of 2 and a replicate name of 1.</li>
                <li>Replicate: The replicate number for the experiment: see above.</li>
                <li>Modality: The modality of the experiment (e.g., Gene expression, ATAC, ADT, etc.)</li>
                <li>Chemistry: The chemistry used for the experiment (e.g., 3' v2, 3' v3, etc.). For more information see <a href="https://kb.10xgenomics.com/hc/en-us/articles/115003764132-How-does-Cell-Ranger-auto-detect-chemistry" target="_blank">here</a>.</li>
                <li>Index type: The type of index used (Single index or dual index). Refer to the assay used, and the plate or primers used to index your library.</li>
                <li>Index: The index used for the experiment. This is the barcode used to identify the sample.</li>
                <li>Species: The species of the sample (Human or mouse)</li>
                <li>Number of donors: The number of donors in this GEM well, used for donor deconvolution. Human only.</li>
                <li>ADT file name: The name of the ADT file used for the experiment. This is the name of the file that contains ADT barcodes. The format must match the format for your experiment, detailed <a href="https://github.com/ollieeknight/OSCAR/tree/main/templates" target="_blank">here</a>.</li>
            </ul>
        </section>        
        
        <form id="csvForm">
            <table>
                <thead>
                    <tr>
                        <th>Assay type</th>
                        <th>Experiment ID</th>
                        <th>Historical number</th>
                        <th>Replicate</th>
                        <th>Modality</th>
                        <th>Chemistry</th>
                        <th>Index type</th>
                        <th>Index</th>
                        <th>Species</th>
                        <th>Number of donors</th>
                        <th>ADT file name</th>
                    </tr>
                </thead>
                <tbody id="rowsContainer">
                    <!-- Rows will be dynamically added here -->
                </tbody>
            </table>
            <button type="button" class="add-row-btn">Add row</button>
        </form>
    </div>

    <script>
        async function fetchRowTemplate() {
            const response = await fetch('row_template.html');
            const template = await response.text();
            return template;
        }

        async function addRow() {
            const container = document.getElementById('rowsContainer');
            const template = await fetchRowTemplate();
            const newRow = document.createElement('tr');
            newRow.innerHTML = template;
            container.appendChild(newRow);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            document.querySelector('.add-row-btn').addEventListener('click', addRow);
            document.querySelector('.generate-csv-btn').addEventListener('click', generateCSV);
            const container = document.getElementById('rowsContainer');
            const template = await fetchRowTemplate();
            const firstRow = document.createElement('tr');
            firstRow.innerHTML = template;
            container.appendChild(firstRow);
        });

        function generateCSV() {
            const rows = document.querySelectorAll('#rowsContainer tr');
            let csvContent = 'assay,experiment_id,historical_number,replicate,modality,chemistry,index_type,index,species,n_donors,adt_file\n';
            let allValid = true;

            rows.forEach(row => {
                const inputs = row.querySelectorAll('input, select');
                const values = Array.from(inputs).map(input => input.value || 'NA');
                let rowValid = true;

                inputs.forEach(input => {
                    if (input.value === '') {
                        input.classList.add('error');
                        rowValid = false;
                    } else {
                        input.classList.remove('error');
                    }
                });

                if (!rowValid) {
                    allValid = false;
                } else {
                    csvContent += values.join(',') + '\n';
                }
            });

            if (allValid) {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'metadata.csv'; // Output file name
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert('Please complete all fields before generating the CSV.');
            }
        }
    </script>
</body>
</html>
