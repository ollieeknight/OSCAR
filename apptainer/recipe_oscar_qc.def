Bootstrap: docker
From: ubuntu:latest

%labels
    # Metadata about the container
    name "Oliver Knight"
    email "oliver.knight@charite.de"

%files
    # Copy the conda environment file into the container
    ../conda/oscar_qc.yml /opt/environment.yml

%environment
    # Set environment variables
    export LC_ALL=C
    export LC_NUMERIC=en_GB.UTF-8
    export PATH="/opt/AMULET/:$PATH"
    . /opt/miniforge3/etc/profile.d/conda.sh
    conda activate oscar_qc

%runscript
    #!/bin/sh
    alias AMULET="/opt/AMULET/AMULET.sh"
    eval "$@"

%post
    # Use bash
    #!/bin/bash

    # Update and upgrade the package lists and install necessary packages
    apt-get update -qq
    apt-get upgrade -y -qq
    apt-get install -y curl git unzip tar nano build-essential wget

    # Create directories for SNP and AMULET
    mkdir -p /opt/SNP/ /opt/AMULET/

    # Download the SNP file
    curl -L -o /opt/SNP/genome1K.phase3.SNP_AF5e2.chr1toX.hg38.vcf.gz "https://www.dropbox.com/scl/fi/qpsdse6dqqjnje53mtyps/genome1K.phase3.SNP_AF5e2.chr1toX.hg38.vcf.gz?rlkey=cxfnlxp8d4zref5eixg0x9uah&st=h5bxgja6&dl=1"

    # Clone the AMULET repository
    git clone https://github.com/UcarLab/AMULET /opt/AMULET/

    # Download RestrictionRepeatLists for AMULET
    curl -sSL -o /opt/AMULET/RestrictionRepeatLists.zip "https://github.com/UcarLab/AMULET/releases/download/v1.0/RestrictionRepeatLists.zip"

    # Unzip the RestrictionRepeatLists and remove the zip file
    unzip -q /opt/AMULET/RestrictionRepeatLists.zip -d /opt/AMULET/ && rm /opt/AMULET/RestrictionRepeatLists.zip

    # Make all files in the AMULET directory executable
    chmod -R +x /opt/AMULET/

    # Install "Miniforge" if it is not already installed
    [ ! -d "/opt/miniforge3" ] && curl -L "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh" -o Miniforge3-Linux-x86_64.sh && bash Miniforge3-Linux-x86_64.sh -b -p "/opt/miniforge3" && rm Miniforge3-Linux-x86_64.sh

    # Source the conda profile script
    . /opt/miniforge3/etc/profile.d/conda.sh

    # Upgrade all conda packages
    conda upgrade --all -y

    # Create the conda environment from the environment file
    conda env create -f /opt/environment.yml

    # Activate the conda environment
    conda activate oscar_qc

    # Clone the mgatk repository and install it
    mkdir -p /opt/mgatk/
    git clone "https://github.com/ollieeknight/mgatk" /opt/mgatk/
    cd /opt/mgatk/
    pip install .
    
    # Clean up conda and pip caches
    conda clean -y -a
    pip cache purge

    # Clean up apt caches and remove unnecessary packages
    apt-get clean
    apt-get autoremove
    rm -rf /var/lib/apt/lists/*